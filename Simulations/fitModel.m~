%% fitModel
% Calculates the maximum-likelihood parameters (and overall negLL) for a
% model.

%% Inputs
% dataPath: path to a file containing 'results', a numRounds x 4 x
% numSubjects, which gives (for each subject & round) [A1 S2 A2 Re].
% environment: path to environment file (see 'likelihood.m' for
% requirements). Should already have practice rounds filtered out.
% savePath: folder to save results in
% numStarts: how many starts to do
% fixedParams: which params to fix, and to what values. There are 7
% possible parameters: [lr temp1 temp2 stay w_MB w_MB_AS use_AS].
%   If you want to let a parameter be free, set to -1.
%   Otherwise, set to the
%   Note that use_AS must be fixed.

function fitModel(dataPath, environment, savePath, numStarts, whichSubj, fixedParams)
%% Load data
load(dataPath);

%% Set up
numSubjects = size(results, 3);

% tasknum is from 1 to numSubjects
if (whichSubj < 1 || whichSubj > numSubjects)
    error('tasknum must be between 1 and numSubjects');
end

% Do params
% [lr temp1 temp2 stay w_MB w_MB_AS]
if use_AS
    bounds = [0 0 0 0 0 0; 1 1 2 2 1 1];
    numParams = 6;
else
end

% Calculate starts
starts = zeros(numStarts,numParams);
for i=1:numParams
    starts(:,i) = linspace(bounds(1,i),bounds(2,i),numStarts);
end

thisSubj = tasknum;
optParams = zeros(numStarts,numParams);
lik = zeros(numStarts,1);

%% Start!
for thisStart = 1:numStarts
    if thisSubj < length(subjMarkers)
        index = subjMarkers(thisSubj):(subjMarkers(thisSubj + 1) - 1);
    else
        index = subjMarkers(thisSubj):length(id);
    end
    
    options = psoptimset('CompleteSearch','on','SearchMethod',{@searchlhs});

    % Do patternsearch
    [optParams(thisStart,:),lik(thisStart),~] = patternsearch(@(params) getLikelihood_daw(params,environment,practiceCutoff,Opt1(index),Opt2(index),Action(index),S2(index),Action2(index),Re(index),round1(index)),starts(thisStart,:),[0 0 0 0 1 1],1,[],[],bounds(1,:),bounds(2,:),options);
end

[~,bestStart] = min(lik);
name = [savePath '/Params_Subj' num2str(tasknum) '.txt'];
csvwrite(name,[lik(bestStart) optParams(bestStart,:)]);
end